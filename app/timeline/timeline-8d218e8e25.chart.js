"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();angular.module("app").service("Timeline",["TIMELINE_CONFIG","TIMELINE_COLORS","$translate","$filter",function(t,e,n,i){var r=function(r){function a(e){_classCallCheck(this,a);var n=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,e));n.configs=t,n.transitionValues=n.transitionValues.bind(n),n.isHighlighted=n.isHighlighted.bind(n),n.updateBubbles=n.updateBubbles.bind(n),n.resetBubbles=n.resetBubbles.bind(n),n.deleteBubbles=n.deleteBubbles.bind(n),n.highlightGroups=n.highlightGroups.bind(n),n.updateLabel=n.updateLabel.bind(n),n.bindLayer=n.bindLayer.bind(n),n.colors=n.colors.bind(n),n.categoryColors=n.categoryColors.bind(n),n.xScale=d3.scaleLinear(),n.yScale=d3.scaleLinear(),n.base.append("g.axis.axis--x"),n.base.append("g.axis.axis--y"),n.base.append("g.ruler");var i=n.base.append("g.area"),r=n.base.append("g.line"),s=n.base.append("g.label");return n.base.append("rect.event").on("mousemove",n.updateBubbles).on("mouseout",n.resetBubbles),n.base.append("g.bubble"),n.base.append("filter#dropshadow").attrs({height:"130%"}).append("feGaussianBlur").attrs({"in":"SourceAlpha",stdDeviation:2}).select(n.parent).append("feOffset").attrs({dx:0,dy:2,result:"offsetblur"}).select(n.parent).append("feFlood").attr("flood-opacity",.4).select(n.parent).append("feComposite").attrs({in2:"offsetblur",operator:"in"}).select(n.parent).append("feMerge").append("feMergeNode").select(n.parent).append("feMergeNode").attr("in","SourceGraphic"),n.line=d3.line().x(function(t){return n.xScale(t.id)}).y(function(t){return n.yScale(t.value)}),n.area=d3.area().x(function(t){return n.xScale(t.id)}).y0(function(t){return n.isStacked?n.yScale(t.stack[0]):n.height}).y1(function(t){return n.yScale(t.value)}),n.layer("area",i,angular.extend(n.bindLayer(n.area),{dataBind:function(t){var e="line"===t.type?[]:t.rows.reverse();return this.selectAll(".area__group").data(e,function(t){return t.id})},insert:function(t){return t.append("path.area__group").classed("highlighted",n.isHighlighted).style("opacity",function(t){return n.isHighlighted(t)?1:.3}).attr("d",function(t){return n.area(t.values)}).style("fill",n.colors)}})),n.layer("line",r,angular.extend(n.bindLayer(n.line),{dataBind:function(t){return this.selectAll(".line__group").data(t.rows,function(t){return t.id})},insert:function(t){return t.append("path.line__group").classed("highlighted",n.isHighlighted).style("opacity",function(t){return n.isHighlighted(t)?1:.3}).attr("d",function(t){return n.line(t.values)}).style("stroke",n.colors)}})),n.layer("label",s,{dataBind:function(t){return this.selectAll(".label text").data(t.rows,function(t){return t.id})},insert:function(t){return t.append("text").text(function(t){return t.id}).classed("highlighted",n.isHighlighted).attr("text-anchor","end").attr("dy","-1em").attr("dx","-1em").call(n.updateLabel).style("opacity",0)},events:{"enter:transition":function(t){return t.duration(n.c("transition")).style("opacity",1)},update:function(t){return t.classed("highlighted",n.isHighlighted)},"update:transition":function(t){return t.duration(n.c("transition")).call(n.updateLabel)},merge:function(t){return t.classed("highlighted",n.isHighlighted)},"merge:transition":function(t){return t.duration(n.c("transition")).call(n.updateLabel)},"exit:transition":function(t){return t.duration(n.c("transition")).style("opacity",0).remove()}}}),n}return _inherits(a,r),_createClass(a,[{key:"formatY",value:function(t){return i("number")(t,0)}},{key:"updateBubbles",value:function(){var t=this,e=function(e){return e.attr("transform",function(e){return"translate("+t.c("padding").left+", "+t.yScale(e.value)+")"}),e.select("text").attr("text-anchor",t.half<a?"end":"start").each(_.partial(function(t){var n=d3.select(this);n.selectAll("*").remove(),n.tspans(function(e){return[e.year,e.id,t.formatY(e.value)]});var i=n.node().getBBox();n.attrs({y:t.c("padding").top});var r=2;e.select("rect").attrs({x:i.x-2*r,y:i.y-r,width:i.width+4*r,height:i.height+2*r})},t)),e},n=this.yScale.invert(d3.event.layerY),i=Math.round(this.xScale.invert(d3.event.layerX)),r=_.first(this.data.years.sort(function(t,e){return Math.abs(i-t)-Math.abs(i-e)})),a=this.xScale(r),s=_.chain(this.data.rows).map(function(t){var e=_.find(t.values,{id:r});return angular.extend(t,{year:r,value:e.value,hover:n>=e.stack[0]&&n<=e.stack[1]})}).thru(function(e){return e=t.isStacked?_.filter(e,{hover:!0}):e.sort(function(t,e){return Math.abs(n-t.value)-Math.abs(n-e.value)})}).first().castArray().compact().value(),l=this.base.select(".bubble").call(this.translate(a,this.c("padding").top)).selectAll(".bubble__group").data(s,function(t){return t.id});l.exit().remove(),l.call(e);var o=l.enter().append("g").classed("bubble__group",!0);o.append("circle").attrs({cx:0,cy:0,r:5,stroke:this.categoryColors,"stroke-width":5,fill:function(e){var n=t.categoryColors(e);return chroma.mix(n,t.contrast(n))}}),o.append("text").style("fill",_.flow(this.categoryColors,this.contrast)),o.insert("rect",":first-child").attrs({rx:2,ry:2}).style("fill",this.categoryColors),o.attr("fill","red").style("filter","url(#dropshadow)").call(e),this.highlightGroups(_.map(s,"id"))}},{key:"resetBubbles",value:function(){this.deleteBubbles(),this.highlightGroups()}},{key:"deleteBubbles",value:function(){this.base.selectAll(".bubble__group").remove()}},{key:"parent",value:function(){return this.parentNode}},{key:"bindLayer",value:function(t){var e=this;return{events:{enter:function(t){var n=_.uniqueId("rectClip-"),i=e.base.append("clipPath").attr("id",n).append("rect");t.attr("clip-path","url(#"+n+")"),i.attrs({width:0,height:e.height}).transition().duration(e.c("transition")).attr("width",e.width).on("end",function(){t.attr("clip-path",null),d3.select(this.parentNode).remove()})},merge:this.transitionValues(t),update:this.transitionValues(t),exit:function(t){t.transition().duration(e.c("transition")).style("opacity",0).on("end",function(){return t.remove()})}}}}},{key:"transitionValues",value:function(t){var e=this;return function(n){n.transition().duration(e.c("transition")).style("opacity",function(t){return e.isHighlighted(t)?1:.3}).attr("d",function(e){return t(e.values)})}}},{key:"updateLabel",value:function(t){var e=this;return t.attr("x",function(t){return e.xScale(_.last(t.values).id)}).attr("y",function(t){var n=_.last(t.values);return e.yScale(n.value)})}},{key:"isHighlighted",value:function(t){return!this.hasHighligths||this.c("highlights").indexOf(t.id)>-1}},{key:"highlightGroups",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=function(t){return e.indexOf(t.id)>-1};this.base.selectAll(".line__group,.area__group").style("opacity",function(e){return n(e)||t.isHighlighted(e)?1:.3}),this.base.selectAll(".line__group").style("stroke",function(e){return n(e)?t.categoryColors(e):t.colors(e)}),this.base.selectAll(".area__group").style("fill",function(e){return n(e)?t.categoryColors(e):t.colors(e)})}},{key:"contrast",value:function(t){return chroma(t).luminance()>.5?"black":"white"}},{key:"colors",value:function(t){var e=this.categoryColors(t);return this.isHighlighted(t)?e:chroma(e).desaturate(1).hex()}},{key:"categoryColors",value:function(t){return this._colors||(this._colors=d3.scaleOrdinal(e)),this._colors(t.id)}},{key:"smooth",value:function(t){var e=this;return _.each(t,function(n,i){if(!isNaN(i)&&t.hasOwnProperty(Number(i)-1)){for(var r=[],a=-e.c("smoothing");a<=e.c("smoothing");a++){var s=Number(i)+a;r.push(t[s])}t[i]=d3.mean(r)}}),t}},{key:"transform",value:function(t){var e=this,i=this.years(t[0]);t=t.map(this.smooth.bind(this));var r=_.chain(t).map(function(t){return _.values(t).pop()}).value(),a=_.map(i,function(e){return angular.extend({year:e},_.reduce(r,function(n,i,r){return n[i]=t[r][e],n},{}))}),s=d3.stack().keys(r)(a),l=_.reduce(t,function(t,r,a){return t.push({id:n.instant("timeline.labels."+r.label),values:_.map(i,function(t){var n=_.find(s[a],function(e){return e.data.year===t});return{id:t,stack:n,value:e.isStacked?n[1]:r[t]}})}),t},[]);return{years:i,rows:l,stack:s,type:this.c("type"),begin:i[0],end:i[i.length-1],min:d3.min(l,function(t){return d3.min(t.values,function(t){return e.isStacked?t.stack[0]:t.value})}),max:d3.max(l,function(t){return d3.max(t.values,function(t){return t.value})})}}},{key:"years",value:function(t){return _.chain(t).keys().remove(function(t){return!isNaN(t)}).map(function(t){return Number(t)}).sort().value()}},{key:"translate",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return function(n){return n.attr("transform","translate("+t+", "+e+")")}}},{key:"isYearVisible",value:function(t){return t>=this.data.begin&&t<this.data.end}},{key:"updateRulers",value:function(){var t=this,e=d3.transition().duration(this.c("transition")),n=function(e){return e.attr("transform",function(e){var n=t.c("padding").left+t.xScale(e[0]),i=t.c("padding").top;return"translate("+n+", "+i+")"})},i=this.c("rulers");i=i.filter(function(e){return t.isYearVisible(e[0])});var r=this.base.select(".ruler").selectAll(".ruler__group").data(i,function(t){return t[0]});r.exit().transition(e).style("opacity",0).remove(),r.transition(e).call(n).style("opacity",1),r.selectAll("line").transition(e).attr("y2",this.height);var a=r.enter().append("g").classed("ruler__group",!0);a.call(n).style("opacity",0).transition(e).style("opacity",1),a.append("line").attrs({x1:0,y1:0,x2:0,y2:this.height}),a.append("text").text(function(t){return t[1]}).attrs({dy:".85em",dx:"1em"})}},{key:"preDraw",value:function(t){var e=this,n=this.c("padding"),i=this.c("min"),r=this.c("max");null===i&&(i=this.isLine?Math.max(t.min-1*(t.max-t.min)/8,0):t.min),null===r&&(r=t.max+1*(t.max-t.min)/8),this.data=t,this.xScale.range([0,this.width]).domain([t.begin,t.end]),this.yScale.range([this.height,0]).domain([i,r]),this.base.attr(_.pick(this,["width","height"])),this.base.classed("timeline__chart--highlights",this.hasHighligths),this.base.selectAll(".line, .area, .event, .label").call(this.translate(n.left,n.top)),this.updateRulers(),this.deleteBubbles(),this.base.select(".event").attrs(_.pick(this,["width","height"])).call(this.translate(n.left,n.top)),this.base.select(".axis--x").call(this.translate(n.left,this.height+n.top)).transition().duration(this.c("transition")).call(d3.axisBottom(this.xScale).tickFormat(d3.format("")).tickValues(t.years.slice(1,-1)).tickSize(0).tickPadding(10)),this.base.select(".axis--y").call(this.translate(n.left,n.top)).transition().duration(this.c("transition")).call(d3.axisLeft(this.yScale).tickSizeOuter(0).tickFormat(this.formatY).tickSize(-this.width)).on("end",function(){e.base.select(".axis--y .tick:last-child text").text(function(t){return e.formatY(t)+" "+(e.c("yunit")||"")})}),this.base.selectAll(".axis--y text").attr("y",2).attr("x",0).attr("dx","4px").attr("dy","-1em").style("text-anchor","start")}},{key:"width",get:function(){return this.c("width")-this.c("padding").left-this.c("padding").right}},{key:"height",get:function(){return this.c("height")-this.c("padding").top-this.c("padding").bottom}},{key:"half",get:function(){return this.width/2}},{key:"isStacked",get:function(){return"stacked-area"===this.c("type")}},{key:"isLine",get:function(){return"line"===this.c("type")}},{key:"isArea",get:function(){return"area"===this.c("type")}},{key:"hasHighligths",get:function(){return this.c("highlights").length>0}}]),a}(Koto);return r}]);
//# sourceMappingURL=../../maps/app/timeline/timeline-8d218e8e25.chart.js.map
